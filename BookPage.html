<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="BookPage/styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
      crossorigin="anonymous"
    />
  </head>
  <body>
    <!--Header starts-->
    <header class="header">
      <div class="left">
        <img src="Main Image/final.png" alt="" class="logo" />
      </div>
      <div class="middle">
        <form action="" class="s">
          <input
            type="search"
            placeholder="Search"
            class="search"
            id="search-item"
            autocapitalize="none"
          />
          <button type="submit" id="search-button">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </form>
      </div>
      <div class="right">
        <ul>
          <a href="index.htm" class=""> <li>Home</li></a>
          <a href="Theme.html" class=""><li>Genre</li></a>
          <a href="contactFinal.htm" class=""><li>Contact Us</li></a>
          <a href="About.html" class=""> <li>About Us</li></a>
          <a href="#" id="user"
            ><li><i class="fa-solid fa-user"></i></li
          ></a>
        </ul>
        <div class="bars" id="menu-icon"><i class="fa-solid fa-bars"></i></div>
      </div>
    </header>
    <!--Header ENDS-->
    <section>
      <div class="container">
        <div class="image">
          <img class="imgs" id="BookImage" alt="Here goes the image" />
        </div>
        <div class="count">
          <div class="title">
            <h1 id="BookTitle">Here goes the title</h1>
          </div>
          <div class="ant">
            <h4 id="BookGenre">Genre</h4>
          </div>
          <div class="synopsis">
            <p id="synopsis">Here goes the synopsis</p>
          </div>
        </div>
      </div>
      <hr />
    </section>
    <section class="similar-books">
      <h2>Similar Books</h2>
      <div class="slider" id="slider"></div>
    </section>
    <hr />
    <section class="review-body">
      <div class="WriteReview">
        <h2>Reviews</h2>
        <p>What do <i>You</i> Think?</p>
        <div class="rating-box">
          <fieldset>
            <form>
              <div class="title-box">
                <input
                  type="text"
                  placeholder="Enter Your Review Title"
                  id="title"
                  autocapitalize="none"
                />
              </div>
              <div class="tarea">
                <textarea
                  cols="30"
                  rows="100"
                  placeholder="Write a Review"
                  id="comments"
                  autocapitalize="none"
                ></textarea>
              </div>
              <div class="bum">
                <button id="submit">Post</button>
              </div>
            </form>
          </fieldset>
        </div>
      </div>
    </section>
    <hr />
    <section class="final-review">
      <div class="following">
        <h2>What Did Others Think</h2>
        <div class="edu-comment" id="edu"></div>
      </div>
    </section>
    <!--Section Footer Begins-->
    <footer class="bg-dark text-white pt-5 pb-4">
      <div class="containFooter text-center text-md-left">
        <div class="row text-center text-md-left">
          <div class="col-md-3 col-lg-3 col-xl-3 mx-auto mt-3">
            <h5 class="text-uppercase mb-4 font-weight-bold text-primary">
              Company Name
            </h5>
            <p class="text-white">BookBuzz</p>
            <p class="text-white">
              Discover BookBuzz, your one-stop destination for book lovers.
              Immerse yourself in captivating stories, lively discussions, and
              curated recommendations. Join our vibrant community and let your
              love for books soar. Get buzzing about books with BookBuzz today!
            </p>
          </div>
          <div class="col-md-2 col-lg-2 col-xl-2 mx-auto mt-3">
            <h5 class="text-uppercase mb-4 font-weight-bold text-primary">
              Available Genre
            </h5>
            <p>
              <a href="#" class="text-white" style="text-decoration: none"
                >Fantasy</a
              >
            </p>
            <p>
              <a href="#" class="text-white" style="text-decoration: none"
                >Mystery</a
              >
            </p>
            <p>
              <a href="#" class="text-white" style="text-decoration: none"
                >Science Fiction</a
              >
            </p>
            <p>
              <a href="#" class="text-white" style="text-decoration: none"
                >Romance</a
              >
            </p>
          </div>

          <div class="col-md-4 col-lg-2 col-xl-2 mx-auto mt-3">
            <h5 class="text-uppercase mb-4 font-weight-bold text-primary">
              Contact Us
            </h5>
            <p class="text-white">
              <i class="fas fa-home mr-3 text-white"></i> Phuentsholing,Chukha
              2023 Bhutan
            </p>
            <p class="text-white">
              <i class="fas fa-envelope mr-3 text-white"></i>
              Bookbuzz023@gmail.com
            </p>
            <p class="text-white">
              <i class="fas fa-phone mr-3 text-white"></i> +975 17864932
            </p>
            <p class="text-white">
              <i class="fas fa-printer mr-3 text-white"></i>+01 385 633 77
            </p>
          </div>
        </div>
        <hr class="mb-4" />
        <div class="row align-items-center">
          <div class="col-md-7 col-lg-8">
            <p class="text-white">
              Copyright &copy All rights reserved by:
              <a href="#" style="text-decoration: none">
                <strong class="text-primary">The provider</strong>
              </a>
            </p>
          </div>
          <div class="col-md-5 col-lg-4">
            <div class="text-center text-md-right"></div>
            <ul class="list-unstyled list-inline">
              <li class="list-inline-item">
                <a
                  href=""
                  class="btn-floating btn-sm text-white"
                  style="font-size: 23px"
                  ><i class="fab fa-facebook text-white"></i
                ></a>
              </li>
              <li class="list-inline-item">
                <a
                  href=""
                  class="btn-floating btn-sm text-white"
                  style="font-size: 23px"
                  ><i class="fab fa-twitter text-white"></i
                ></a>
              </li>
              <li class="list-inline-item">
                <a
                  href=""
                  class="btn-floating btn-sm text-white"
                  style="font-size: 23px"
                  ><i class="fab fa-google text-white"></i
                ></a>
              </li>
              <li class="list-inline-item">
                <a
                  href=""
                  class="btn-floating btn-sm text-white"
                  style="font-size: 23px"
                  ><i class="fab fa-linkedin text-white"></i
                ></a>
              </li>
              <li class="list-inline-item">
                <a
                  href=""
                  class="btn-floating btn-sm text-white"
                  style="font-size: 23px"
                  ><i class="fab fa-youtube text-white"></i
                ></a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </footer>
  </body>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getDatabase,
      set,
      ref,
      onValue,
      update,
      child,
      push,
      get,
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA-uwO2oey_TBYu_Xpwms3VcBO068Ic0a8",
      authDomain: "miniproject-1ca20.firebaseapp.com",
      databaseURL:
        "https://miniproject-1ca20-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "miniproject-1ca20",
      storageBucket: "miniproject-1ca20.appspot.com",
      messagingSenderId: "56934343229",
      appId: "1:56934343229:web:c457a2cc065b0b6847c054",
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth();

    //This is for the hamburger menu
    let menu = document.querySelector("#menu-icon");
    let navlist = document.querySelector(".right ul ");

    menu.onclick = () => {
      // menu.classList.toggle("bx-x");
      navlist.classList.toggle("open");
    };

    // Retrieve the search query parameter from the URL
    const urlParams = new URLSearchParams(window.location.search);
    const bookTitleQuery = urlParams.get("q");

    //Getting the book ref
    const bookref = ref(database, "Books/");

    //Getting the requested book
    get(bookref)
      .then((snapshot) => {
        const bookData = snapshot.val();
        const bookImage = document.getElementById("BookImage");
        const bookTitle = document.getElementById("BookTitle");
        const bookGenre = document.getElementById("BookGenre");
        const synopsis = document.getElementById("synopsis");
        Object.keys(bookData).forEach((bookId) => {
          const book = bookData[bookId];
          // Access the book properties
          const titleBook = book.title;
          if (bookTitleQuery === titleBook) {
            const genreBook = book.genre;
            const imageUrlBook = book.imageUrl;
            const description = book.description;
            //Using InnerHtml to set data
            bookImage.src = imageUrlBook;
            bookTitle.innerHTML = titleBook;
            bookGenre.innerHTML = genreBook;
            synopsis.innerHTML = description;

            findSimilarBooks(genreBook, titleBook);
          }
        });
      })
      .catch((error) => {
        console.error("There is an error" + error);
      });

    //For similar Books
    function findSimilarBooks(genre, title) {
      get(bookref)
        .then((snapshot) => {
          const bookData = snapshot.val();
          const slider = document.getElementById("slider");
          Object.keys(bookData).forEach((bookId) => {
            const book = bookData[bookId];
            // Access the book properties
            const genreBook = book.genre;
            const titleBook = book.title;
            if (genre === genreBook) {
              if (titleBook === title) {
                return;
              }
              const imageUrlBook = book.imageUrl;

              const box = document.createElement("div");
              box.setAttribute("data-card-id", titleBook);
              const img = document.createElement("img");
              img.setAttribute("data-card-id", titleBook);
              const details = document.createElement("div");
              details.setAttribute("data-card-id", titleBook);
              const h6 = document.createElement("h6");
              h6.setAttribute("data-card-id", titleBook);

              box.className = "box";
              details.className = "details";

              img.src = imageUrlBook;
              h6.textContent = titleBook;
              details.appendChild(h6);
              box.appendChild(img);
              box.appendChild(details);
              slider.appendChild(box);
            }
          });
        })
        .catch((error) => {
          console.error("There is an error" + error);
        });
    }

    //When Similar books is clicked
    const slider = document.getElementById("slider");
    slider.addEventListener("click", function (event) {
      event.preventDefault();
      // Code to execute when a card is clicked
      const clickedCard = event.target; // Get the actual card element that was clicked
      const title = clickedCard.getAttribute("data-card-id");
      window.location.href = "BookPage.html?q=" + encodeURIComponent(title);
      console.log("Card clicked:", clickedCard.getAttribute("data-card-id"));
    });

    //Initializing button
    const submitButton = document.getElementById("submit");
    const reviewRef = ref(database, "Reviews/");
    submitButton.addEventListener("click", function (event) {
      event.preventDefault();
      onAuthStateChanged(auth, (user) => {
        if (user) {
          const review = document.getElementById("comments").value;
          const formattedText = review.replace(/\n/g, "<br>"); // Replace line breaks with HTML <br> tags
          const title = document.getElementById("title").value;
          const userId = auth.currentUser.uid;
          const dataToBeAdded = {
            title: title,
            review: formattedText,
            userId: userId,
            BookTitle: bookTitleQuery,
          };

          push(reviewRef, dataToBeAdded);
          addBooksReviewed(bookTitleQuery);
        } else {
          alert("You must sign in to write a review");
        }
      });
      setTimeout(function () {
        location.reload();
      }, 1000);
    });

    //For BooksReviewed
    function addBooksReviewed(bookTitle) {
      const userId = auth.currentUser.uid;
      const BooksReviewedRef = ref(
        database,
        "users/" + userId + "/BooksReviewed"
      );
      var flag = false;
      get(BooksReviewedRef)
        .then((snapshot) => {
          if (snapshot.exists()) {
            const checkBooks = snapshot.val();

            Object.keys(checkBooks).forEach((reviewedBookId) => {
              const reviewedBook = checkBooks[reviewedBookId];
              const titleBook = reviewedBook.bookTitle;
              console.log("titleBook: " + titleBook);
              console.log("bookTitle: " + bookTitle);
              if (titleBook.toLowerCase() === bookTitle.toLowerCase()) {
                flag = true;
                console.log(flag);
                pushBook(flag);
                throw new Error("Found Book");
              }
            });
            pushBook(flag);
          } else {
            pushBook(flag);
          }
        })
        .catch((error) => {
          console.error("Book Found" + error);
        });

      function pushBook(flag) {
        const bookData = { bookTitle: bookTitle };
        console.log("The book Title is: " + bookTitle);
        if (!flag) {
          push(BooksReviewedRef, bookData);
          console.log("bOOK pUSHED");
        } else {
          console.log("Book Already there");
        }
      }
    }
    //Referencing the review database
    const reviewsRef = ref(database, "Reviews");
    const userRef = ref(database, "users");

    //Retrieving the Review
    console.log(bookTitleQuery);
    get(reviewsRef)
      .then((snapshot) => {
        if (snapshot.exists()) {
          const reviewdata = snapshot.val();

          // Iterate over the book IDs and retrieve the book details
          Object.keys(reviewdata).forEach((reviewId) => {
            const review = reviewdata[reviewId];

            // Access the book properties
            const reviewData = review.review;
            const reviewTitle = review.title;
            const userId = review.userId;
            const BookTitle = review.BookTitle;

            if (BookTitle === bookTitleQuery) {
              //initializing the elements
              const div1 = document.createElement("div");
              const div2 = document.createElement("div");
              const div3 = document.createElement("div");
              const h6 = document.createElement("h6");
              const span = document.createElement("span");
              const img = document.createElement("img");
              const hr = document.createElement("hr");
              //Get Element from HTML file
              const edu = document.getElementById("edu");

              //Creating new Reference to get the userId
              const userRef = ref(database, "users/" + userId);
              get(userRef)
                .then((snapshot) => {
                  const userData = snapshot.val();
                  img.src = userData.profile_picture;
                  h6.textContent = "@" + userData.userName;
                })
                .catch((error) => {
                  console.error("There is an error" + error);
                });
              //Give Class name to the items
              div1.className = "thumbnail";
              div2.className = "comment-content";
              div3.className = "comment-top";
              span.className = "subtitle";

              // Do something with the book data
              // img.src = "About/About Image/JPW.jpg";
              // h6.textContent = "@" + "Author Name";
              span.textContent = reviewTitle;

              //Adding the created element
              div3.appendChild(h6);
              div2.appendChild(div3);
              div2.appendChild(span);

              //for paragraphs
              const paragraphs = reviewData.split("/n");
              paragraphs.forEach((paragraphText) => {
                const paragraphElement = document.createElement("p");
                paragraphElement.innerHTML = paragraphText;
                div2.appendChild(paragraphElement);
              });
              div2.appendChild(hr);
              div1.appendChild(img);
              edu.appendChild(div1);
              edu.appendChild(div2);
            }
          });
        } else {
          console.log("No Review for this Book.");
        }
      })
      .catch((error) => {
        console.error("Error retrieving reviews:", error);
      });
    //Function menu
    document.querySelector("#user").addEventListener("click", function () {
      checkUser();
    });
    function checkUser() {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          console.log("Working");
          window.location.href = "profilePage.html";
        } else {
          window.location.href = "Login.html";
        }
      });
    }
    // Reference to your Firebase Realtime Database
    const databaseRef = ref(database, "Books");
    const searchButton = document.getElementById("search-button");
    const searchInput = document.getElementById("search-item");
    var SearchTerm;
    searchButton.addEventListener("click", function (event) {
      event.preventDefault();
      SearchTerm = searchInput.value;
      window.location.href =
        "newsearch.html?q=" + encodeURIComponent(SearchTerm);
    });
  </script>
</html>
